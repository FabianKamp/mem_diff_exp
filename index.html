<!DOCTYPE html>
<html lang="en"></html>
<html>
  <head>
    <title>Experiment</title>
    
    <script src="jquery/jquery-3.7.1.min.js"></script>

    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-external-html.js"></script>
    <script src="jspsych/plugin-fullscreen.js"></script>
    <script src="jspsych/plugin-survey.js"></script>
    <script src="jspsych/plugin-survey-html-form.js"></script>
    <script src="jspsych/plugin-survey-text.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-slider-response.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    
    <script src="experimentHelper.js"></script>
    
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="jspsych/survey.css" rel="stylesheet" type="text/css" />
    <link href="experiment.css" rel="stylesheet" type="text/css" />

</head>
  <body></body>
  <script>
    async function main () {
    const jsPsych = initJsPsych({
        on_finish: function(data){            
            // Serialize the data
            var promise = new Promise(function(resolve, reject) {
                var data = JSON.stringify(jsPsych.data);
                resolve(data);
            })

            promise.then(function(data) {
                $.ajax({
                    type: "POST",
                    url: '/save',
                    data: { "data": data },
                    success: function(){ document.location = "/next" },
                    dataType: "application/json",

                    // Endpoint not running, local save
                    error: function(err) {
                        if (err.status == 200){
                            document.location = "/next";
                        } else {
                            // If error, assue local save
                            jsPsych.data.get().localSave('json', 'mem_diff.json');
                        }
                    }
                });
            })
            // window.location.href = "https://app.prolific.com/"
        }
    });

    // experiment parameters
    const inter_trial_delay = 1000; //ms (1000 has a good feel)
    const inter_img_delay = 220; //ms
    const memory_delay = 5000; //ms

    // TODO update the instructions

    // TODO reset the subject ID to the original 
    // TODO instruction for the response format
    // var subject_id = jsPsych.data.getURLVariable('sid')
    var subject_id = 10

    // var version_code = jsPsych.data.getURLVariable('vc')
    version_code = "00"
    // var load_condition = jsPsych.data.getURLVariable('load')
    var load_condition = "high-load" // high-load
    const load = (load_condition === "high-load") ? 7 : 5; // number of enc images

    // var response_format = jsPsych.data.getURLVariable('response')
    var response_format = "2afc" // n-o

    // define version 
    var version = `${load_condition}_${response_format}`
    
    // radius for image presentation
    var rx = 220; //px
    var ry = 180; //px

    if (load_condition === "high-load") {
        rx += 50
    }

    // TODO read from URL
    // var sequential = (jsPsych.data.getURLVariable('seq') == 'N') ? false : true;
    var sequential =  false;

    // var encoding_time = (jsPsych.data.getURLVariable('etime') == 'short') ? 300 : 500;
    var encoding_time = 300
    encoding_time = (sequential) ? encoding_time*1 : encoding_time*load; //ms
    
    // add meta data
    jsPsych.data.addProperties({
        startTime : new Date().toISOString().replace('T', ' ').slice(0, 19),
        subject_id: subject_id,
        version_code: version_code,
        OS : window.navigator.platform,
        fullscreen_mode: true, 
        radius_x: rx, 
        radius_y: ry, 
        memory_delay: memory_delay
    });

    // load practice data
    var practice_input_data = await fetch(`input_data/instructions/${version}.json`)
        .then(response => response.json())
        .catch(error => console.error(error));

    // load wm image data
    subject_id_str = String(subject_id).padStart(3, '0')
    var wm_input_data = await fetch(`input_data/${version}/wm_input_subject_${subject_id_str}.json`)
        .then(response => response.json())
        .catch(error => console.error(error));

    // split into blocks
    var wm_input_data_block1 = wm_input_data.filter((trial) => trial.wm_block_id === 1);
    var wm_input_data_block2 = wm_input_data.filter((trial) => trial.wm_block_id === 2);

    // load lm image data
    var lm_input_data = await fetch(`input_data/${version}/lm_input_subject_${subject_id_str}.json`)
        .then(response => response.json())
        .catch(error => console.error(error));
    
    // split into blocks
    var lm_input_data_block1 = lm_input_data.filter((trial) => trial.lm_block_id === 1);
    var lm_input_data_block2 = lm_input_data.filter((trial) => trial.lm_block_id === 2);

    // consent
    var participantConsentStatus = null;
    var check_consent = function(elem) {
            if (!document.getElementById('consent_checkbox').checked && !document.getElementById('no_consent_checkbox').checked) {
                alert("Please indicate whether you consent to participate or not.");
                return false;
            }
            if (document.getElementById('no_consent_checkbox').checked) {
                participantConsentStatus = "Participant does not consent and is redirected";
                
                // Redirect to Prolific or any other action for non-consenting participants
                window.location.href = "https://app.prolific.com/";
                return false;
            }
            participantConsentStatus = "Participant has read consent form and consents to study participation.";
            return true;
        };

    var consent = {
        type: jsPsychExternalHtml,
        url: 'consent_form/EXTERNAL_CONSENT_PAGE.HTML',
        cont_btn: 'continue_button',
        check_fn: check_consent,
        on_finish: function() {
            // Log consent status
            jsPsych.data.get().last(1).addToAll({
                consent_status: participantConsentStatus
            })}
        }

    // fullscreen
    var enter_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        message:         
        `<div class="instruction-container">
            <p class="instruction-header"><strong>Welcome to the experiment!</strong></p>
            <p class="instruction-paragraph">
                We will now enter fullscreen mode.
                <br><br>
                To ensure the quality of the results, we'd ask you to 
                <br>
                <strong>remain in fullscreen mode during the entire experiment</strong>.
                <br><br>
                Once the experiment is over, you will be redirected to Prolific automatically. 
                Please, don\'t close the experiment until this happens.
                </br><br><br>
                To enter fullscreen mode and <span>continue</span>, please click <span style="font-style: italic;">Continue</span>.
            </p>
        </div>`,
    }

    // check & reenter fullscreen
    var reenter_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        message: 
        `<div class="instruction-container">
            <p class="instruction-paragraph">
                We detected that you exited the fullscreen mode.<br><br>
                To ensure the quality of the results, we'd kindly ask you to <strong>remain in fullscreen mode</strong> for the duration of the experiment.<br><br>
                Once the experiment is over, you will automatically be redirected to Prolific, so please don\'t close the experiment until this happens.</br><br><br>
                To reenter fullscreen mode and <span>continue</span>, please click <span style="font-style: italic;">Continue</span>.
            </p>
        </div>`,
        delay_after: 1000
    }
    var fullscreenExits = 0; 
    var check_fullscreen = {
        timeline: [reenter_fullscreen],
        conditional_function: function() {
            var interactionData = jsPsych.data.getInteractionData();
            if (fullscreenExits < interactionData.filter({event: 'fullscreenexit'}).count()) {
                fullscreenExits = interactionData.filter({event: 'fullscreenexit'}).count(); 
                jsPsych.data.get().push({
                    fullscreen_exit_detected: true,
                    timestamp: new Date().toLocaleTimeString()
                });
                return true;
            }
            else {
                return false; 
            }
        }
    };          

    // demographics
    var demographics = {
        type: jsPsychSurvey,
        survey_json: {
            pages: [{
                name: 'page1',
                elements: [
                {
                    type: "html",
                    name: "Title",
                    html: 
                        `<p style="font-size: x-large; color:#4682B4;">
                            <strong>Please fill in the questions below before we start</strong>
                        </p>`
                },
                {
                    type: 'text',
                    title: 'How old are you?', 
                    name: 'age', 
                    isRequired: false,
                    inputType: 'number',
                    min: 0,
                    max: 100,
                },
                {
                    type: 'radiogroup',
                    title: 'Which gender do you identify with?', 
                    choices: ['Diverse', 'Female','Male','I prefer not to say'],
                    name: 'Gender',
                    required: true
                }, 
                {
                    type: 'text',
                    title: 'Paste your Prolific ID below', 
                    name: 'prolificID', 
                    isRequired: true,
                    inputType: 'text',
                },
                ]
            }] 
        }};

    // INSTRUCTIONS
    // change encoding slide depending on the load condition
    var encoding_slide = 
        `<div class="instruction-container">`

    if (load_condition=="high-load") {
        var instruction_angles = [3.276, 5.072, 1.481, 4.174, 2.379, 0.584, 5.969]        
    } else {
        var instruction_angles = [0.792, 5.818, 2.048, 4.562, 3.305]
    }
    sample_pos = convert2cartesian(rx, ry, instruction_angles[3])

    for (let i = 0; i < instruction_angles.length; i++) {
        var pos = convert2cartesian(rx,ry, instruction_angles[i])
        encoding_slide += 
            `<div class="image-container"> 
                <img src="stimuli/instructions/instruction_slide/enc${i+1}.jpg" class="image-object" 
                style="left: calc(50% - ${pos.x}px); top: calc(50% + ${pos.y}px);"/>
            </div>`
    }

    var sequential_text = (sequential) ? `<strong>sequentially</strong>` : ``
    encoding_slide += 
        `<div class="cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>
            <p class="instruction-paragraph" style="position: absolute; top: 30%; left: 5%; font-size:large; width: 250px; text-align: left;">
                <strong>1. Memorize.</strong> We will ask you to memorize <strong>${load}</strong> images. 
                The images will be presented ${sequential_text} at random positions on your display.
            </p>
            <p style="position: absolute; bottom: 10px; font-size: medium; color:#4682B4;">
                To continue press <strong>right arrow</strong>.
            </p>
        </div>`
    
    // response slide
    instruction_slider = 
        `<div style="width: 350px; text-align: left; position: absolute; top: 80vh;">
            <input type="range" class="jspsych-slider" value="50" min="5" max="95" step="15" id="jspsych-html-slider-response-response"/>
            <div style="position: absolute; left: 35%; top: 100%; transform: translateX(-50%) rotate(-15deg); font-size: small; 
                color: rgba(0,0,0,.6); margin-top: 0px;">
                <span>guess</span>
            </div>
            <div style="position: absolute; left: 20%; top: 100%; transform: translateX(-50%) rotate(-15deg); font-size: small; 
                color: rgba(0,0,0,.6); margin-top: 0px;">
                <span>probably</span>
            </div>
            <div style="position: absolute; left: 5%; top: 100%; transform: translateX(-50%) rotate(-15deg); font-size: small; 
                color: rgba(0,0,0,.6); margin-top: 0px;">
                <span>certain</span>
            </div>
            <div style="position: absolute; left: 65%; top: 100%; transform: translateX(-50%) rotate(-15deg); font-size: small; 
                color: rgba(0,0,0,.6); margin-top: 0px;">
                <span>guess</span>
            </div>
            <div style="position: absolute; left: 80%; top: 100%; transform: translateX(-50%) rotate(-15deg); font-size: small; 
                color: rgba(0,0,0,.6); margin-top: 0px;">
                <span>probably</span>
            </div>
            <div style="position: absolute; left: 95%; top: 100%; transform: translateX(-50%) rotate(-15deg); font-size: small; 
                color: rgba(0,0,0,.6); margin-top: 0px;">
                <span>certain</span>
            </div>
        </div>`
    
    if (response_format != "2afc") {
        wm_recognition_slide = 
            `<div class="instruction-container">
                <div class="image-container-4"> 
                    <img src="stimuli/instructions/instruction_slide/wm_recog.jpg" class="image-object" 
                    style="left: calc(50% - ${sample_pos.x}px); top: calc(50% + ${sample_pos.y}px); opacity: 0.4;"/>
                </div>
                <div class="cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>`
        wm_recognition_slide += instruction_slider
        wm_recognition_slide +=
                `<p class="instruction-paragraph" style="position: absolute; top: 50%; left: 5%; font-size:large; width: 300px; text-align: left;">
                    <strong>4. Have you seen this image before at this position?</strong> Please, respond using the <strong>slider</strong>. 
                    The left side indicates that the image is <strong>"same"</strong> as before and 
                    the right side means that this is a <strong>"different"</strong> image.
                    Use the slider to indicate how confident (guess, probably, confident) you are about your decision as shown above.  
                    You have to move the slider of center to continue.
                </p>
                <p style="position: absolute; bottom: 10px; font-size: medium; color:#4682B4;">
                    To continue press <strong>right arrow</strong>
                </p>
            </div>`
    } else {
        wm_recognition_slide = 
            `<div class="instruction-container">
                <div> 
                    <div class="square" 
                        style="left: calc(50% - ${sample_pos.x}px); top: calc(50% + ${sample_pos.y}px);"></div>
                </div>
                
                <div class="image-container-1"> 
                    <img src="stimuli/instructions/instruction_slide/enc4.jpg" class="image-object" 
                    style="top: 50%; left: calc(50% - 60px);"/>
                </div>
                
                <div class="image-container-2"> 
                    <img src="stimuli/instructions/instruction_slide/wm_recog.jpg" class="image-object" 
                    style="top: 50%; left: calc(50% + 60px);"/>
                </div>`
        wm_recognition_slide += instruction_slider
        wm_recognition_slide +=
                `<p class="instruction-paragraph" style="position: absolute; top: 47%; left: 5%; font-size:large; width: 300px; text-align: left;">
                    <strong>3. Which image have you seen before?</strong> 
                    The square indicates the position at which the image appeared before.
                    Please, respond using the slider. 
                    The left side indicates that you have seen the left image before and 
                    the right side means that you have seen the right image before.
                    Use the slider to indicate how confident (guess, probably, confident) you are about your decision.  
                    <br><br><strong>Important,</strong> you have to move the slider of center to continue.
                </p>
                <p style="position: absolute; bottom: 10px; font-size: medium; color:#4682B4;">
                    To continue press <strong>right arrow</strong>
                </p>
            </div>`
    }

    var wm_instruction = {
        type: jsPsychInstructions,
        key_forward: 'ArrowRight',
        key_backward: 'ArrowLeft',
        show_clickable_nav: false,
        record_data: false,
        pages: [
            [
            `<div class="instruction-container">
                <p class="instruction-header"><strong>Instructions</strong></p>
                <p class="instruction-paragraph">
                    During this experiment, we will ask you to memorize images that appear at different positions on your the display.
                    <br><br>
                    The following instructions will explain in detail how the task works.
                    <br><br><br><br>
                    <strong>The instructions are self-paced</strong>. You can navigate back and forth through the instructions using the arrow keys on your keyboard.</p>
                <p style="position: absolute; bottom: 10px; font-size: medium; color:#4682B4;">
                    To continue press <strong>right arrow</strong>.
                </p>
            </div>`
            ],
            encoding_slide,
            [
            `<div class="instruction-container">
                <div class="cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>       
                <p class="instruction-paragraph" style="position: absolute; top: 30%; left: 5%; font-size:large; width: 300px; text-align: left;">
                    <strong>2. Delay.</strong> The image presentation will be followed by a short delay. 
                    The delay will only take a couple of seconds. Please, focus on the cross on the screen during the delay.
                </p>
                <p style="position: absolute; bottom: 10px; font-size: medium; color:#4682B4;">
                    To continue press <strong>right arrow</strong>.
                </p>
            </div>`
            ],
            wm_recognition_slide,
            [
            `<div class="instruction-container">
                <p class="instruction-header"><strong>Practice</strong></p>
                <p class="instruction-paragraph">
                    We will continue with <strong>three practice runs</strong>.
                    <br><br>
                    Please try to memorize the images as well as you can.
                    <br>
                    Respond using the slider.</p>
                <p style="position: absolute; bottom: 10px; font-size: medium; color:#4682B4;">
                    To continue press <strong>right arrow</strong>.
                </p>
            </div>`
            ]
        ]
        }
    
    // start wm experiment
    var start_wm = {
        type: jsPsychInstructions,
        show_clickable_nav: false,
        key_forward: 'Enter',
        record_data: false,
        post_trial_gap: 200,
        min_viewing_time: 3000,
        pages: [
            [
            `<div class="instruction-container">
                <p class="instruction-header"><strong>Starting the experiment</strong></p>
                <p class="instruction-paragraph">
                    We will now start the experiment.<br><br>
                    The next break will be in ~15 minutes.<br><br><br><br>
                </p>
                <p style="position: absolute; bottom: 30%; font-size: x-large; color:#4682B4;">
                    Press <strong>Enter</strong> to start. 
                </p>
            </div>`
            ]
        ],
    }
    
    // break
    var break_trial = {
        type: jsPsychHtmlKeyboardResponse, 
        stimulus: 
            `<div class="instruction-container">
                <p class="instruction-header"><strong>Break</strong></p>
                <p class="instruction-paragraph"> 
                    If you need a break, you can take one now.<br>
                    Please allow yourself a maximum of 2 minutes.<br><br><br>
                    <strong>The task will continue automatically after 2 minutes.</strong>
                </p>
                <p style="position: absolute; bottom: 5%; font-size: medium; color:#4682B4;">
                    When you are ready to continue press <strong>Enter</strong>
                </p>
            </div>`,
        choices: ['Enter'],
        trial_duration: 120000, // 2 minutes
        response_ends_trial: true,
        on_finish: function(data) {
            if(data.rt === null) {
                data.break_ending = "ended by timeout after 2 minutes";
            } 
            else {
                data.break_ending = "ended by participant's action after " + data.rt + " ms";
            }
            data.stimulus = null;
            data.trial_type = "break";
            data.timestamp = new Date().toLocaleTimeString()
        }
    }

    // countdown
    function countdown(seconds) {
        var counter = []; 
        for (let i = 0; i < seconds; i++) {
            counter.push(
            {
                type: jsPsychHtmlKeyboardResponse,
                choices: "NO_KEYS",
                trial_duration: 1000,
                record_data: false,
                stimulus: function(){
                    var html = 
                        `<div class="instruction-container">
                            <p class="instruction-paragraph">
                                The next experimental block will start in <br><strong>${seconds-i} seconds</strong>.
                            </p>
                        </div>`
                    return html;
                }
            })
        }
        return {timeline:counter}; 
    }

    // TODO fix size and position of the recognition slide 
    if (response_format != "2afc") {
        lm_recognition_slide = 
            `<div class="instruction-container">
                <div> 
                    <img src="stimuli/instructions/instruction_slide/enc3.jpg" style="position: absolute; border-radius:10px; 
                    height:200px; width:200px; top: 50%; left: 50%;
                    transform: translate(-50%, -50%);"/>
                </div>`
        lm_recognition_slide += instruction_slider
        lm_recognition_slide +=
                `<p class="instruction-paragraph" style="position: absolute; top: 50%; left: 5%; font-size:large; width: 300px; text-align: left;">
                    <strong>4. Have you seen this image?</strong>
                    As before, please respond using the slider. The left side indicates that the image has been shown before (i.e. it is <strong>old</strong>), 
                    the right side means that has not been shown (i.e. it is <strong>new</strong>).
                    Use the slider to indicate how confident (guess, probably, confident) you are about your decision as shown above.  
                    You have to move the slider of center to continue to the next trial.
                </p>
                <p style="position: absolute; bottom: 10px; font-size: medium; color:#4682B4;">
                    To continue press <strong>right arrow</strong>
                </p>
            </div>`
    } else {
        lm_recognition_slide = 
            `<div class="instruction-container">                
                <div class="image-container-1"> 
                    <img src="stimuli/instructions/instruction_slide/enc3.jpg" class="image-object" 
                    style="top: 50%; left: calc(50% - 120px); height:200px; width:200px;"/>
                </div>
                <div class="image-container-1"> 
                    <img src="stimuli/instructions/instruction_slide/lm_recog.jpg" class="image-object" 
                    style="top: 50%; left: calc(50% + 120px); height:200px; width:200px;"/>
                </div>`
        lm_recognition_slide += instruction_slider
        lm_recognition_slide +=
                `<p class="instruction-paragraph" style="position: absolute; top: 45%; left: 5%; font-size:large; width: 300px; text-align: left;">
                    <strong>4. Have you seen this image?</strong>
                    As before, please respond using the slider. The left side indicates that the image has been shown before (i.e. it is <strong>old</strong>), 
                    the right side means that has not been shown (i.e. it is <strong>new</strong>).
                    Use the slider to indicate how confident (guess, probably, confident) you are about your decision as shown above.  
                    You have to move the slider of center to continue to the next trial.
                </p>
                <p style="position: absolute; bottom: 10px; font-size: medium; color:#4682B4;">
                    To continue press <strong>right arrow</strong>
                </p>
            </div>`
    }

    // instructions long term memory 
    var lm_instructions =         
        {
            type: jsPsychInstructions,
            key_forward: 'ArrowRight',
            record_data: false,
            pages:[[
                `<div class="instruction-container">
                    <p class="instruction-paragraph"> 
                        <strong>Great, you are almost done!</strong>
                        <br><br><br>
                        In the last task we will now show you images again and want to know if you remember the images from the first task.
                        <br><br>
                        For each image we will ask if you have seen it before (i.e. during the first/second block of the experiment)
                        <br><br><br><br>
                        The The following instructions will explain the task in detail. 
                    </p>
                    <p style="position: absolute; bottom: 10px; font-size: medium; color:#4682B4;">
                        To continue press <strong>right arrow</strong>.
                    </p>
                </div>`
            ], 
            lm_recognition_slide
            ],
        };
    
    // start lm
    var start_lm = {
        type: jsPsychInstructions,
        show_clickable_nav: false,
        record_data: false,
        key_forward: 'Enter',
        post_trial_gap: 200,
        min_viewing_time: 3000,
        pages: [
            [
            `<div class="instruction-container">
                <p class="instruction-header"><strong>Starting the last task</strong></p>
                <p class="instruction-paragraph">
                    We will now start the last task of this experiment.<br><br>
                    This will take ~10 minutes.
                </p>
                <p style="position: absolute; bottom: 30%; font-size: x-large; color:#4682B4;">
                    Press <strong>Enter</strong> to start. 
                </p>
            </div>`
            ]
        ], 
    }
    // end experiment
    var end_experiment = {
        type: jsPsychHtmlKeyboardResponse,
        trial_duration: 10000,
        stimulus:
            '<p><strong>End Of Experiment</strong></p>' + 
            '<br>' + 
            '<p>Thank you for participating!</p>' +
            '<p>Press <strong>Enter</strong> to get redirected to Prolific.</p>' +
            '<p>After 10 seconds you will be redirected automatically.</p>',
        key_forward: 'Enter',
        on_start: async function() {
            jsPsych.data.addProperties({ 
                experiment_complete: true,
                endTime: new Date().toISOString().replace('T', ' ').slice(0, 19),
            });
        },
        on_finish: function(data){
            data.stimulus = null
            data.trial_type = "end-slide"
        }
    };

    // TASK WRAPPERS
    slider_labels = 
        [
            `<span style="font-size: x-small; transform: rotate(-30deg); display: inline-block;">certain</span>`,
            `<span style="font-size: x-small; transform: rotate(-30deg); display: inline-block;">probably</span>`,
            `<span style="font-size: x-small; transform: rotate(-30deg); display: inline-block;">guess</span>`,
            `<span style="font-size: x-small; transform: rotate(-30deg); display: inline-block;"> </span>`,
            `<span style="font-size: x-small; transform: rotate(-30deg); display: inline-block;">guess</span>`,
            `<span style="font-size: x-small; transform: rotate(-30deg); display: inline-block;">probably</span>`,
            `<span style="font-size: x-small; transform: rotate(-30deg); display: inline-block;">certain</span>`
        ]
    
    // WM TASK
    function createWM(timeline_variables) {
        // timeline: initial delay -> 3 encoding images (inter stimulus delay) -> memory delay -> recognition slide
        var wm_timeline = [];
        
        // preload
        wm_timeline.push(
        {
            type: jsPsychPreload,
            record_data: false,
            show_progress_bar: false,
            images: function() {
                var files = [];
                for (let j = 0; j < load; j++) {
                    files.push(jsPsych.evaluateTimelineVariable(`encoding_file_${j+1}`));
                }
                files.push(jsPsych.evaluateTimelineVariable('wm_recognition_file'))
                return files;
            }
        })

        // inter trial delay
        wm_timeline.push(
        {
            type: jsPsychHtmlKeyboardResponse,
            choices: "NO_KEYS",
            trial_duration: inter_trial_delay,
            record_data: false,
            stimulus: function(){
                var html = 
                `<div style="width:250px; height:75vh;">
                    <div class="cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>
                </div>`
                return html;
            }
        })

        // encoding
        if (sequential) {
            for (let i = 0; i < load; i++) {
                if (i != 0) {
                    wm_timeline.push(
                    {
                        type: jsPsychHtmlKeyboardResponse,
                        choices: "NO_KEYS",
                        trial_duration: inter_img_delay,
                        record_data: false,
                        stimulus: function(){
                            var html = 
                            `<div style="width:250px; height:75vh;">
                                <div class="cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>
                            </div>`
                            return html;
                        }
                    })
                }
                
                wm_timeline.push(
                    {
                        type: jsPsychHtmlKeyboardResponse,
                        choices: "NO_KEYS",
                        trial_duration: encoding_time,
                        stimulus: function() {
                            var file = jsPsych.evaluateTimelineVariable(`encoding_file_${i+1}`)
                            var theta = jsPsych.evaluateTimelineVariable(`encoding_theta_${i+1}`)
                            var pos = convert2cartesian(rx, ry, theta)
                            var html =                         
                            `<div style="width:500px; height:75vh;">
                                <div> 
                                    <img src="${file}" class="image-object" 
                                    style="top: calc(50% - ${pos.y}px); left: calc(50% + ${pos.x}px);"/>
                                </div>
                                <div class="cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>
                            </div>`
                            return html;},
                        
                        on_finish: function(data) { 
                            var file = jsPsych.evaluateTimelineVariable(`encoding_file_${i+1}`)
                            var theta = jsPsych.evaluateTimelineVariable(`encoding_theta_${i+1}`)
                            data.stimulus = file
                            data.theta = theta
                            data.trial_type = "encoding";
                            data.wm_trial_id = jsPsych.evaluateTimelineVariable('wm_trial_id');
                            data.timestamp = new Date().toLocaleTimeString()

                        }
                    })
            }
        } else {
        
        wm_timeline.push(
            {
                type: jsPsychHtmlKeyboardResponse,
                choices: "NO_KEYS",
                trial_duration: encoding_time,
                stimulus: function() {
                    var html = `<div style="width:500px; height:75vh;">`
                    for (let i = 0; i < load; i++) {
                        var file = jsPsych.evaluateTimelineVariable(`encoding_file_${i+1}`)
                        var theta = jsPsych.evaluateTimelineVariable(`encoding_theta_${i+1}`)
                        var pos = convert2cartesian(rx, ry, theta)
                        html +=                         
                        `<div style="width:500px; height:75vh;">
                            <div> 
                                <img src="${file}" class="image-object" 
                                style="top: calc(50% - ${pos.y}px); left: calc(50% + ${pos.x}px);"/>
                            </div>
                        </div>`
                    }
                    html += 
                    `<div class="cross">
                        <div class="cross-vertical"></div>
                        <div class="cross-horizontal"></div>
                    </div></div>`
                    return html;},
                
                on_finish: function(data) { 
                    var file = []
                    var theta = []
                    for (let i = 0; i < load; i++) { 
                        file.push(jsPsych.evaluateTimelineVariable(`encoding_file_${i+1}`))
                        theta.push(jsPsych.evaluateTimelineVariable(`encoding_theta_${i+1}`))
                    }
                    data.stimulus = file
                    data.theta = theta
                    data.wm_trial_id = jsPsych.evaluateTimelineVariable('wm_trial_id')
                    data.trial_type = "encoding";
                    data.timestamp = new Date().toLocaleTimeString()
                }
            })
        }

        // delay
        wm_timeline.push(
            {
                type: jsPsychHtmlKeyboardResponse,
                choices: "NO_KEYS",
                trial_duration: memory_delay,
                record_data: false,
                stimulus: function(){
                    var html = 
                        `<div style="width:250px; height:75vh;">
                            <div class="cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>
                        </div>`
                    return html;
                }
            })
        
        // recognition
        if (response_format != "2afc") {
            wm_timeline.push(
                {
                    type: jsPsychHtmlSliderResponse,
                    require_movement: false,
                    // slider_start: Math.floor(Math.random() * 101),
                    slider_start: 50,
                    slider_width: 280,
                    min: 5,
                    max: 95,
                    step: 15,
                    labels: slider_labels,
                    css_classes : ["next-trial-btn"],

                    stimulus: function() {
                        var file = jsPsych.evaluateTimelineVariable('wm_recognition_file')
                        var theta = jsPsych.evaluateTimelineVariable('recognition_theta')
                        var pos = convert2cartesian(rx, ry, theta)
                        var html = 
                            `<div style="width:500px; height:75vh;">
                                <p style="font-size: x-large; position: absolute; top: 50px; left: 50%; 
                                transform: translateX(-50%); color:#4682B4; text-align: center;">
                                    <strong>Is this the same image as before?</strong>
                                </p>
                                <div> 
                                    <img src="${file}" class="image-object" 
                                    style="top: calc(50% - ${pos.y}px); left: calc(50% + ${pos.x}px);"/>
                                </div>
                                <div class="cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>
                            </div>`
                        return html;
                    },

                    // forces the slider to be move off center before the next trial starts
                    on_load: () => {
                        let moved = false;
                        const slider = document.querySelector('input[type="range"]');
                        const nextBtn = document.querySelector('#jspsych-html-slider-response-next');

                        nextBtn.disabled = true;
                        slider.addEventListener('input', () => {
                            if (parseInt(slider.value) !== 50) {
                            moved = true;
                            nextBtn.disabled = false;
                            } else {
                            moved = false;
                            nextBtn.disabled = true;
                            }
                        });
                    },
                
                    on_finish: function(data) { 
                        data.wm_trial_id = jsPsych.evaluateTimelineVariable('wm_trial_id')
                        data.image_id = jsPsych.evaluateTimelineVariable('wm_id')
                        data.stimulus = jsPsych.evaluateTimelineVariable('wm_recognition_file')
                        data.theta = jsPsych.evaluateTimelineVariable('recognition_theta')
                        data.wm_condition = jsPsych.evaluateTimelineVariable('wm_condition')
                        data.wm_position = jsPsych.evaluateTimelineVariable('wm_position')
                        data.lm_position = jsPsych.evaluateTimelineVariable('lm_position')
                        data.trial_type = "wm-recognition"
                        data.timestamp = new Date().toLocaleTimeString()

                    }
            })
        
        } else {
            wm_timeline.push(
                {
                    type: jsPsychHtmlSliderResponse,
                    require_movement: false,
                    slider_start: 50,
                    slider_width: 260,
                    min: 5,
                    max: 95,
                    step: 15,
                    labels: slider_labels,
                    css_classes : ["next-trial-btn"],
                    stimulus: function() {
                        var idx = jsPsych.evaluateTimelineVariable('wm_position')
                        var enc_file = jsPsych.evaluateTimelineVariable(`encoding_file_${idx}`)
                        var recog_file = jsPsych.evaluateTimelineVariable('wm_recognition_file')
                        var left_correct = jsPsych.evaluateTimelineVariable('left_correct') 
                        
                        if (left_correct === 1) {
                            var left_image = enc_file
                            var right_image = recog_file
                        } else {
                            var left_image = recog_file
                            var right_image = enc_file 
                        }

                        var theta = jsPsych.evaluateTimelineVariable('recognition_theta')
                        var pos = convert2cartesian(rx, ry, theta)

                        var html = 
                            `<div style="width:500px; height: 75vh;">
                                <p style="font-size: x-large; position: absolute; top: 50px; left: 50%; 
                                transform: translateX(-50%); color:#4682B4; text-align: center;">
                                    <strong></strong>
                                </p>
                                
                                <div> 
                                    <div class="square" 
                                        style="top: calc(50% - ${pos.y}px); left: calc(50% + ${pos.x}px);"></div>
                                </div>
                                
                                <div> 
                                    <img src="${left_image}" class="image-object" 
                                    style="top: 50%; left: calc(50% + 60px);"/>
                                </div>
                                
                                <div> 
                                    <img src="${right_image}" class="image-object" 
                                    style="top: 50%; left: calc(50% - 60px);"/>
                                </div> 
                            </div>`
                        return html;
                    },
                    on_load: () => {
                        let moved = false;
                        const slider = document.querySelector('input[type="range"]');
                        const nextBtn = document.querySelector('#jspsych-html-slider-response-next');

                        nextBtn.disabled = true;
                        slider.addEventListener('input', () => {
                            if (parseInt(slider.value) !== 50) {
                            moved = true;
                            nextBtn.disabled = false;
                            } else {
                            moved = false;
                            nextBtn.disabled = true;
                            }
                        });
                    },
                    on_finish: function(data) { 
                        data.wm_trial_id = jsPsych.evaluateTimelineVariable('wm_trial_id')
                        data.image_id = jsPsych.evaluateTimelineVariable('wm_id')
                        data.stimulus = jsPsych.evaluateTimelineVariable('wm_recognition_file')
                        data.theta = jsPsych.evaluateTimelineVariable('recognition_theta')
                        data.wm_condition = jsPsych.evaluateTimelineVariable('wm_condition')
                        data.wm_position = jsPsych.evaluateTimelineVariable('wm_position')
                        data.lm_position = jsPsych.evaluateTimelineVariable('lm_position')
                        data.left_correct = jsPsych.evaluateTimelineVariable('left_correct') 
                        data.trial_type = "wm-recognition"
                        data.timestamp = new Date().toLocaleTimeString()

                    }
                }
            )
        }
        return {timeline:wm_timeline, timeline_variables:timeline_variables};
    }

    // long term memory task
    function createLM(timeline_variables) {
        var lm_timeline = [];
        // small delay
        lm_timeline.push(
            {
                type: jsPsychHtmlKeyboardResponse,
                choices: "NO_KEYS",
                trial_duration: inter_trial_delay,
                record_data: false,
                stimulus: function(){
                    var html = 
                    `<div style="width:250px; height:75vh;">
                            <div class="cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>
                    </div>`
                    return html;
                }
            })
        
        // image presentation
        if (response_format != "2afc") {
            lm_timeline.push(
                {
                    type: jsPsychHtmlSliderResponse,
                    require_movement: false, // defined later in on load
                    slider_start: 50,
                    slider_width: 250,
                    min: 5,
                    max: 95,
                    step: 15,
                    labels: slider_labels,
                    css_classes : ["next-trial-btn"],
                    stimulus: function() {
                        var file = jsPsych.evaluateTimelineVariable('lm_recognition_file')
                        var html = 
                            `<div style="width:500px; height:75vh;">
                                <p style="font-size: x-large; position: absolute; top: 50px; left: 50%; 
                                transform: translateX(-50%); color:#4682B4; text-align: center;">
                                    <strong>Have you seen this image before?</strong>
                                </p>    
                                <div> 
                                    <img src="${file}" style="position: absolute; border-radius:10px; 
                                    height:200px; width:200px; top: 50%; left: 50%;
                                    transform: translate(-50%, -50%);"/>
                                </div>
                            </div>`
                        return html;
                        },
                    on_load: () => {
                        let moved = false;
                        const slider = document.querySelector('input[type="range"]');
                        const nextBtn = document.querySelector('#jspsych-html-slider-response-next');

                        nextBtn.disabled = true;
                        slider.addEventListener('input', () => {
                            if (parseInt(slider.value) !== 50) {
                            moved = true;
                            nextBtn.disabled = false;
                            } else {
                            moved = false;
                            nextBtn.disabled = true;
                            }
                        });
                    },
                    on_finish: function(data) { 
                        data.stimulus = jsPsych.evaluateTimelineVariable('lm_recognition_file')
                        data.image_id = jsPsych.evaluateTimelineVariable('lm_id')
                        data.condition = jsPsych.evaluateTimelineVariable('lm_condition')
                        data.lm_trial_id = jsPsych.evaluateTimelineVariable('lm_trial_id')
                        data.encoding_trial_id = jsPsych.evaluateTimelineVariable('encoding_trial_id')

                        data.trial_type = "lm-recognition";
                        data.timestamp = new Date().toLocaleTimeString()
                    }
                }
            )
            
        } else {
            lm_timeline.push(
                {
                    type: jsPsychHtmlSliderResponse,
                    require_movement: false,
                    // slider_start: Math.floor(Math.random() * 101),
                    slider_start: 50,
                    slider_width: 260,
                    min: 5,
                    max: 95,
                    step: 15,
                    labels: slider_labels,
                    css_classes : ["next-trial-btn"],
                    stimulus: function() {
                        var enc_file = jsPsych.evaluateTimelineVariable('lm_encoding_file')
                        var recog_file = jsPsych.evaluateTimelineVariable('lm_recognition_file')

                        if (jsPsych.evaluateTimelineVariable(`left_correct`) === 1) {
                            var left_image = enc_file
                            var right_image = recog_file
                        } else {
                            var left_image = recog_file
                            var right_image = enc_file 
                        }

                        var html = 
                            `<div style="width:500px; height: 70vh;">
                                <p style="font-size: x-large; position: absolute; top: 50px; left: 50%; 
                                transform: translateX(-50%); color:#4682B4; text-align: center;">
                                    <strong></strong>
                                </p>
                                
                                <div> 
                                    <img src="${left_image}" class="image-object" 
                                    style="height:200px; width:200px; top: 50%; left: calc(50% + 120px);"/>
                                </div>
                                <div> 
                                    <img src="${right_image}" class="image-object" 
                                    style="height:200px; width:200px; top: 50%; left: calc(50% - 120px);"/>
                                </div>                                
                            </div>`
                        return html;
                    }, 
                    on_load: () => {
                        let moved = false;
                        const slider = document.querySelector('input[type="range"]');
                        const nextBtn = document.querySelector('#jspsych-html-slider-response-next');
                        nextBtn.disabled = true;
                        slider.addEventListener('input', () => {
                            if (parseInt(slider.value) !== 50) {
                            moved = true;
                            nextBtn.disabled = false;
                            } else {
                            moved = false;
                            nextBtn.disabled = true;
                            }
                        });
                    },
                    on_finish: function(data) { 
                        data.stimulus = jsPsych.evaluateTimelineVariable('lm_recognition_file')
                        data.image_id = jsPsych.evaluateTimelineVariable('lm_id')
                        data.condition = jsPsych.evaluateTimelineVariable('lm_condition')
                        data.lm_trial_id= jsPsych.evaluateTimelineVariable('lm_trial_id')
                        data.encoding_trial_id = jsPsych.evaluateTimelineVariable('encoding_trial_id')
                        data.left_correct = jsPsych.evaluateTimelineVariable('left_correct')

                        data.trial_type = "lm-recognition";
                        data.timestamp = new Date().toLocaleTimeString()
                    }
                }
            )
        }
        return {timeline:lm_timeline, timeline_variables:timeline_variables};
    }

    // distractor instructions 
    var distractor_instructions =         
        {
            type: jsPsychHtmlKeyboardResponse, 
            record_data: false,
            stimulus: 
            `<div class="instruction-container">
                <p class="instruction-paragraph"> 
                    <strong>Great, you have successfully completed the first task!</strong>
                    <br><br><br>
                    We will now ask you to do some basic mental math for ~2 minutes.<br><br>
                    We will ask you to <strong>substract numbers from 100</strong><br>
                    <em>(e.g. 100-3=97 <span style="font-size:x-large;">&#8594;</span> 97-5=92 
                        <span style="font-size:x-large;">&#8594;</span> 92-3=89 ... )</em>.
                    <br><br>
                    You will see each number for 5 seconds.
                    <br><br><br><br><br>
                    You are free to take a short break now before beginning the next task (max. 2 minutes)
                </p>
                <p style="position: absolute; bottom: 5%; font-size: medium; color:#4682B4;">To continue press <strong>Enter</strong></p>
            </div>`, 
            choices: ['Enter'],
            trial_duration: 120000, // 2 minutes
            response_ends_trial: true,
        };

    // distractor task
    function createDistractorTask() {  
        var initial_number = 100; 
        var dt_timeline = [];    
        record_data: false; 
        dt_timeline.push(
            {
            type: jsPsychHtmlKeyboardResponse, 
            choices: "NO_KEYS",
            record_data: false,
            stimulus: 
                `<div class="instruction-container">
                    <p class="instruction-paragraph" style="top:45%"> 
                        The initial number is <strong>${initial_number}</strong>.
                    </p>
                </div>`,
            choices: ['Enter'],
            trial_duration: 5000,
            response_ends_trial: true,
            }
        );
        var total = initial_number;
        for (let j = 0; j < 3; j++) {
            for (let i = 0; i < 5; i++) {
                // delay            
                dt_timeline.push(
                {
                    type: jsPsychHtmlKeyboardResponse,
                    choices: "NO_KEYS",
                    trial_duration: 1000, //ms
                    record_data: false,
                    stimulus: function(){
                        var html = 
                        `<div style="width:250px; height:75vh;">
                            <div class="cross"><div class="cross-vertical"></div><div class="cross-horizontal"></div></div>
                        </div>`
                    return html;
                    }
                }); 
                
                let randomInteger = Math.floor(Math.random() * 5) + 2;
                // substract number
                dt_timeline.push(
                {
                    type: jsPsychHtmlKeyboardResponse,
                    choices: "NO_KEYS",
                    record_data: false,
                    trial_duration: 5000, //ms
                    stimulus: function(){
                        total -= randomInteger;
                        var html = 
                        `<div class="instruction-container">
                            <p class="instruction-paragraph" style="top:45%"> 
                                Substract <strong>${randomInteger}</strong> from the previous number.</p>
                        </div>`
                        return html}
                })           
            };
            // which is the current number?
            dt_timeline.push(
            {
                type: jsPsychSurveyText,
                questions: [{prompt: 'What is the current number?'}],
                on_finish: function(data) {
                    data.trial_type = "distractor-task";
                    data.correct_response = total;
                    data.stimulus = null
                    data.timestamp = new Date().toLocaleTimeString();
                }
            })
            
            if (j == 2) {
                continue;
            }
            // continue substracting
            dt_timeline.push(
                {
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['Enter'],
                    record_data:false,
                    trial_duration: 10000,
                    stimulus: function(){
                        if (parseInt(jsPsych.data.get().last(1).values()[0].response["Q0"], 10) === total) {
                            var feedback = `Awesome, that was the correct number!`
                        } else {
                            var feedback = `Almost, the correct number was <strong>${total}</strong>.`
                        }

                        var html = 
                        `<div class="instruction-container">
                            <p class="instruction-paragraph"> 
                                ${feedback}<br><br>
                                Please, continue to substract<br>starting from <strong>${total}</strong>.
                            </p>
                            <p style="position: absolute; bottom: 5%; font-size: medium; color:#4682B4;">To continue press <strong>Enter</strong></p>
                        </div>`
                        return html;
                    }
                })
        };
        return {timeline:dt_timeline};
    }
    
    // push everything into timeline
    var experiment_timeline = [];

    // experiment_timeline.push(consent)
    // experiment_timeline.push(enter_fullscreen)
    // experiment_timeline.push(demographics)

    // experiment_timeline.push(wm_instruction)
    // experiment_timeline.push(check_fullscreen)
    // experiment_timeline.push(createWM(practice_input_data))

    // WM BLOCK 1
    // experiment_timeline.push(start_wm)
    // experiment_timeline.push(check_fullscreen)
    experiment_timeline.push(createWM(wm_input_data_block1))

    // LM BLOCK 1
    // experiment_timeline.push(distractor_instructions)
    // experiment_timeline.push(check_fullscreen)
    // experiment_timeline.push(createDistractorTask())
    // experiment_timeline.push(lm_instructions)
    // experiment_timeline.push(start_lm)
    // experiment_timeline.push(check_fullscreen)
    // experiment_timeline.push(createLM(lm_input_data))

    // BREAK
    // experiment_timeline.push(break_trial)
    // experiment_timeline.push(check_fullscreen)
    
    // WM BLOCK 2
    // experiment_timeline.push(countdown(5))
    // experiment_timeline.push(createWM(wm_input_data_block2))

    // experiment_timeline.push(distractor_instructions)
    // experiment_timeline.push(check_fullscreen)
    // experiment_timeline.push(createDistractorTask())

    // experiment_timeline.push(lm_instructions)
    // experiment_timeline.push(start_lm)
    // experiment_timeline.push(check_fullscreen)
    experiment_timeline.push(createLM(lm_input_data))
    // experiment_timeline.push(end_experiment)

    // run
    jsPsych.run(experiment_timeline);
    } main()

</script>
</html>
