<!DOCTYPE html>
<html lang="en"></html>

<html>
  <head>
    <title>Experiment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <script src="jquery/jquery-3.7.1.min.js"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-external-html.js"></script>
    <script src="jspsych/plugin-fullscreen.js"></script>
    <script src="jspsych/plugin-survey.js"></script>
    <script src="jspsych/plugin-survey-html-form.js"></script>
    <script src="jspsych/plugin-survey-text.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-html-slider-response.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    
    <script src="tasks/lmTask.js"></script>
    <script src="tasks/wmTask.js"></script>
    <script src="tasks/decisionTask.js"></script>
    <script src="tasks/distractorTask.js"></script>

    <script src="consent/consent.js"></script>
    <script src="surveys/demographics.js"></script>
    <script src="experimentFlow.js"></script>
    
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="jspsych/survey.css" rel="stylesheet" type="text/css" />
    <link href="experiment.css" rel="stylesheet" type="text/css" />
    
</head>
  <body></body>
  <script>
    const jsPsych = initJsPsych({
        on_finish: function(data){            
            // Serialize the data
            var promise = new Promise(function(resolve, reject) {
                var data = JSON.stringify(jsPsych.data);
                resolve(data);
            })

            promise.then(function(data) {
                $.ajax({
                    type: "POST",
                    url: '/save',
                    data: { "data": data },
                    success: function(){ document.location = "/next" },
                    dataType: "application/json",

                    // Endpoint not running, local save
                    error: function(err) {
                        if (err.status == 200){
                            document.location = "/next";
                        } else {
                            // If error, assue local save
                            jsPsych.data.get().localSave('json', 'out_data.json');
                        }
                    }
                });
            })
        }
        });

    // shortcuts
    setupShortcuts(jsPsych);

    async function createTimeline(){        
        // load session/subject/wave id
        // const session_id = "V-PA-001"
        // const session_id = "M-PA-059"
        const session_id = jsPsych.data.getURLVariable('sid')
        const version_id = session_id[0];
        const wave_id = session_id.slice(2, 4)
        const subject_id = parseInt(session_id.slice(-3), 10)

        // add meta data 
        jsPsych.data.addProperties({
            session_id : session_id,
            version_id : version_id,
            wave_id : wave_id,
            subject_id : subject_id,
            startTime : new Date().toISOString().replace('T', ' ').slice(0, 19),
            OS : window.navigator.platform,
            fullscreen_mode: true, 
        });

        // initialize the fullscree tracker
        fullscreen_tracker = new fullscreenTracker(jsPsych);
        
        // load data
        var input_data = await fetch(`input_data/input_${session_id}.json`)
            .then(response => response.json())
            .catch(error => console.error(error));
        
        if (version_id == 'M') {
            console.log("starting memory task")
            
            // split data into practice, wm and lm task
            var practice_input_data = input_data.filter((trial) => trial.trial_type === "practice");
            var wm_input_data = input_data.filter((trial) => trial.trial_type === "wm" || trial.trial_type === "catch");
            var lm_input_data = input_data.filter((trial) => trial.trial_type === "lm");

            // split into blocks
            var wm_input_data_block1 = wm_input_data.filter((trial) => trial.wm_block_id === 1);
            var wm_input_data_block2 = wm_input_data.filter((trial) => trial.wm_block_id === 2);

            // Overall timeline
            var experiment_timeline = [];

            // starting 
            experiment_timeline.push({
                timeline: [
                    check_consent(jsPsych, version_id),
                    startingExperiment(jsPsych),
                    createDemographics(),
                ], 
                name: 'exp_start'        
            })

            // WM instructions
            experiment_timeline.push({
                timeline: [
                    createWMInstructions()
                ], 
                name: 'wm_instructions'
            })
            
            // WM practice
            experiment_timeline.push({
                timeline: [
                    startingWMPractice(),
                    fullscreen_tracker.check(),
                    countdown(3),
                    createWM(practice_input_data, feedback=1, jsPsych)
                ], 
                name: 'wm_practice'
            })

            // WM block 1
            experiment_timeline.push({
                timeline: [
                    startingWM(),
                    fullscreen_tracker.check(),
                    countdown(3),
                    createWM(wm_input_data_block1, feedback=0, jsPsych)
                ], 
                name: "wm_block_1"
            })

            // WM break 
            experiment_timeline.push({
                timeline: [
                    createBreak()
                ], 
                name: "wm_break"
            })

            // WM block 2
            experiment_timeline.push({
                timeline: [
                    fullscreen_tracker.check(),
                    countdown(3),
                    createWM(wm_input_data_block2, feedback=0, jsPsych), 
                    endingWM()
                ], 
                name: "wm_block_2"
            })

            // distractor task
            experiment_timeline.push({
                timeline: [
                    createDistractorInstructions(),
                    fullscreen_tracker.check(),
                    countdown(3),
                    createDistractorTask()
                ],
                name: "distractor_task"
            })

            // LM INSTRTUCIONS
            experiment_timeline.push({
                timeline: [
                    createLMInstructions(),
                ],
                name: "lm_instructions"
            })

            // LM TASK
            experiment_timeline.push({
                timeline: [
                    startingLM(),
                    fullscreen_tracker.check(),
                    countdown(3),
                    createLM(lm_input_data, jsPsych),
                ], 
                name: "lm_task"
            })

            // Ending experiment 
            experiment_timeline.push({
                timeline: [
                    endingExperiment(jsPsych),
                ], 
                name: "exp_end"
            })

        } else if (version_id == 'V') {
            console.log("starting vision task")
            var experiment_timeline = [];

            // starting 
            experiment_timeline.push({
                timeline: [
                    check_consent(jsPsych, version_id),
                    startingExperiment(jsPsych),
                    createDemographics(),
                ], 
                name: 'exp_start'        
            })

            // INSTRUCTIONS
            experiment_timeline.push({
                timeline: [
                    createDecisionInstructions(),
                ], 
                name: 'instructions'        
            })
            
            // vision task
            experiment_timeline.push({
                timeline: [
                    startingDecisionTask(),
                    fullscreen_tracker.check(),
                    countdown(3),
                    createDecisionTask(input_data, jsPsych),
                ], 
                name: 'vision_task'        
            })

            // ENDING
            experiment_timeline.push({
                timeline: [
                    endingExperiment(jsPsych),
                ], 
                name: 'exp_ending'        
            })      
        }
        return experiment_timeline;
    }

    // run
    async function runExperiment() {
        const experiment_timeline = await createTimeline();
        jsPsych.run(experiment_timeline)
    }

    runExperiment()

</script>
</html>
