<!DOCTYPE html>
<html lang="en"></html>

<html>
  <head>
    <title>Experiment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <script src="jquery/jquery-3.7.1.min.js"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-external-html.js"></script>
    <script src="jspsych/plugin-fullscreen.js"></script>
    <script src="jspsych/plugin-survey.js"></script>
    <script src="jspsych/plugin-survey-html-form.js"></script>
    <script src="jspsych/plugin-survey-text.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-html-slider-response.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    
    <script src="tasks/lmTask.js"></script>
    <script src="tasks/wmTask.js"></script>
    <script src="tasks/decisionTask.js"></script>
    <script src="tasks/distractorTask.js"></script>

    <script src="consent/consent.js"></script>
    <script src="surveys/demographics.js"></script>
    <script src="experimentFlow.js"></script>
    
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="jspsych/survey.css" rel="stylesheet" type="text/css" />
    <link href="experiment.css" rel="stylesheet" type="text/css" />
    
</head>
  <body></body>
  <script>
    const jsPsych = initJsPsych({
        on_finish: function(data){            
            // Serialize the data
            var promise = new Promise(function(resolve, reject) {
                var data = JSON.stringify(jsPsych.data);
                resolve(data);
            })

            promise.then(function(data) {
                $.ajax({
                    type: "POST",
                    url: '/save',
                    data: { "data": data },
                    success: function(){ document.location = "/next" },
                    dataType: "application/json",

                    // Endpoint not running, local save
                    error: function(err) {
                        if (err.status == 200){
                            document.location = "/next";
                        } else {
                            // If error, assue local save
                            jsPsych.data.get().localSave('json', 'out_data.json');
                        }
                    }
                });
            })
        }
        });

    async function createTimeline(){        
        // load session/subject/wave id
        // const session_id = "V-PA-001"
        const session_id = "M-PA-001"
        // const session_id = jsPsych.data.getURLVariable('sid')
        const version_id = session_id[0];
        const wave_id = session_id.slice(2, 4)
        const subject_id = parseInt(session_id.slice(-3), 10)

        // add meta data 
        jsPsych.data.addProperties({
            session_id : session_id,
            version_id : version_id,
            wave_id : wave_id,
            subject_id : subject_id,
            startTime : new Date().toISOString().replace('T', ' ').slice(0, 19),
            OS : window.navigator.platform,
            fullscreen_mode: true, 
        });

        // initialize the fullscree tracker
        fullscreen_tracker = new fullscreenTracker(jsPsych);
        
        // load data
        var input_data = await fetch(`input_data/input_${session_id}.json`)
            .then(response => response.json())
            .catch(error => console.error(error));
        
        if (version_id == 'M') {
            console.log("starting memory task")
            
            // split data into practice, wm and lm task
            var practice_input_data = input_data.filter((trial) => trial.trial_type === "practice");
            var wm_input_data = input_data.filter((trial) => trial.trial_type === "wm" || trial.trial_type === "catch");
            var lm_input_data = input_data.filter((trial) => trial.trial_type === "lm");

            // split into blocks
            var wm_input_data_block1 = wm_input_data.filter((trial) => trial.wm_block_id === 1);
            var wm_input_data_block2 = wm_input_data.filter((trial) => trial.wm_block_id === 2);

            // Overall timeline
            // push everything into timeline
            var experiment_timeline = [];

            // STARTING 
            experiment_timeline.push(check_consent(jsPsych))
            experiment_timeline.push(startingExperiment(jsPsych))
            experiment_timeline.push(createDemographics())

            // WM INSTRUCTIONS
            experiment_timeline.push(createWMInstructions())
            experiment_timeline.push(startingWMPractice())
            experiment_timeline.push(fullscreen_tracker.check())
            experiment_timeline.push(countdown(3))
            experiment_timeline.push(createWM(practice_input_data, feedback=1, jsPsych))

            // WM BLOCK 1
            experiment_timeline.push(startingWM())
            experiment_timeline.push(fullscreen_tracker.check())
            experiment_timeline.push(countdown(3))
            experiment_timeline.push(createWM(wm_input_data_block1, feedback=0, jsPsych))

            // // BREAK
            experiment_timeline.push(createBreak())
            experiment_timeline.push(fullscreen_tracker.check())

            // WM BLOCK 2
            experiment_timeline.push(countdown(3))
            experiment_timeline.push(createWM(wm_input_data_block2, feedback=0, jsPsych))
            experiment_timeline.push(endingWM())

            // DISTRACTOR
            experiment_timeline.push(createDistractorInstructions())
            experiment_timeline.push(fullscreen_tracker.check())
            experiment_timeline.push(countdown(3))
            experiment_timeline.push(createDistractorTask())

            // LM INSTRTUCIONS
            experiment_timeline.push(createLMInstructions())
            experiment_timeline.push(startingLM())
            experiment_timeline.push(fullscreen_tracker.check())

            // // LM TASK
            experiment_timeline.push(countdown(3))
            experiment_timeline.push(createLM(lm_input_data, jsPsych))
            experiment_timeline.push(endingExperiment(jsPsych))

        } else if (version_id == 'V') {
            console.log("starting vision task")
            var experiment_timeline = [];

            // STARTING 
            experiment_timeline.push(check_consent(jsPsych, version_id))
            experiment_timeline.push(startingExperiment(jsPsych))
            experiment_timeline.push(createDemographics())

            // INSTRUCTIONS
            experiment_timeline.push(createDecisionInstructions())
            
            // DECISION TASK
            experiment_timeline.push(fullscreen_tracker.check())
            experiment_timeline.push(startingDecisionTask())
            experiment_timeline.push(countdown(3))
            experiment_timeline.push(createDecisionTask(input_data, jsPsych))

            // ENDING
            experiment_timeline.push(endingExperiment(jsPsych))        
        }

        return experiment_timeline;
    }

    // run
    async function runExperiment() {
        const experiment_timeline = await createTimeline();
        jsPsych.run(experiment_timeline)
    }

    runExperiment()

</script>
</html>
